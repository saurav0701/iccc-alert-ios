<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLS Stream Diagnostic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            margin-bottom: 20px;
            color: #4CAF50;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
            color: white;
            font-size: 14px;
        }
        button {
            width: 100%;
            padding: 14px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
        }
        button:hover {
            background: #45a049;
        }
        .results {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        .result-item {
            margin-bottom: 15px;
            padding: 12px;
            background: #1a1a1a;
            border-radius: 6px;
            border-left: 4px solid #666;
        }
        .result-item.success {
            border-left-color: #4CAF50;
        }
        .result-item.error {
            border-left-color: #f44336;
        }
        .result-item.warning {
            border-left-color: #ff9800;
        }
        .result-item h3 {
            margin-bottom: 8px;
            font-size: 14px;
            color: #aaa;
        }
        .result-item p {
            margin: 4px 0;
            font-size: 13px;
        }
        .code {
            background: #000;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            margin-top: 8px;
        }
        video {
            width: 100%;
            max-height: 400px;
            background: #000;
            border-radius: 8px;
            margin-top: 20px;
        }
        .presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        .preset-btn {
            padding: 10px;
            background: #333;
            border: 1px solid #444;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            text-align: left;
        }
        .preset-btn:hover {
            background: #444;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç HLS Stream Diagnostic Tool</h1>
        
        <div class="presets">
            <button class="preset-btn" onclick="testStream('http://103.208.173.195:8888/172.16.28.104/index.m3u8')">
                üìπ Camera 172.16.28.104
            </button>
            <button class="preset-btn" onclick="testStream('http://103.208.173.195:8888/172.16.28.50/index.m3u8')">
                üìπ Camera 172.16.28.50
            </button>
            <button class="preset-btn" onclick="testStream('http://103.208.173.195:8888/172.16.28.14/index.m3u8')">
                üìπ Camera 172.16.28.14
            </button>
            <button class="preset-btn" onclick="testStream('http://a10va.bccliccc.in:8888/172.16.8.83/index.m3u8')">
                üìπ Working Camera (8.83)
            </button>
        </div>

        <div class="input-group">
            <label>Or Enter Custom Stream URL:</label>
            <input type="text" id="streamUrl" placeholder="http://server:8888/camera_id/index.m3u8">
        </div>
        
        <button onclick="testCurrentStream()">üöÄ Test Stream</button>
        
        <div id="results" class="results" style="display: none;"></div>
        
        <video id="video" controls playsinline style="display: none;"></video>
    </div>

    <script>
        const resultsDiv = document.getElementById('results');
        const video = document.getElementById('video');
        let testResults = [];

        function addResult(title, message, type = 'info', code = null) {
            testResults.push({title, message, type, code, time: new Date()});
            renderResults();
        }

        function renderResults() {
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<h2>Diagnostic Results:</h2>';
            
            testResults.forEach(result => {
                const div = document.createElement('div');
                div.className = `result-item ${result.type}`;
                
                const time = result.time.toLocaleTimeString();
                div.innerHTML = `
                    <h3>${result.title} <span style="color: #666; float: right;">${time}</span></h3>
                    <p>${result.message}</p>
                    ${result.code ? `<div class="code">${result.code}</div>` : ''}
                `;
                resultsDiv.appendChild(div);
            });
        }

        function testCurrentStream() {
            const url = document.getElementById('streamUrl').value.trim();
            if (!url) {
                alert('Please enter a stream URL');
                return;
            }
            testStream(url);
        }

        async function testStream(url) {
            testResults = [];
            video.style.display = 'none';
            
            addResult('üé¨ Testing Stream', url, 'info');
            
            // Test 1: Check if URL is reachable
            addResult('üì° Step 1: Checking URL Accessibility', 'Testing if stream URL is reachable...');
            
            try {
                const response = await fetch(url, {method: 'HEAD', mode: 'no-cors'});
                addResult('‚úÖ URL Reachable', 'Stream URL responds to requests', 'success');
            } catch (e) {
                addResult('‚ö†Ô∏è URL Check', 'Cannot verify URL (CORS may be blocking, but stream might still work)', 'warning');
            }
            
            // Test 2: Fetch manifest
            addResult('üìÑ Step 2: Fetching HLS Manifest', 'Downloading index.m3u8...');
            
            try {
                const manifestResponse = await fetch(url);
                const manifestText = await manifestResponse.text();
                
                if (manifestText.includes('#EXTM3U')) {
                    addResult('‚úÖ Valid HLS Manifest', 'Manifest file is valid HLS format', 'success');
                    
                    // Parse manifest
                    const lines = manifestText.split('\n');
                    const segments = lines.filter(line => line.endsWith('.ts') || line.endsWith('.m3u8'));
                    
                    addResult('üìä Manifest Info', 
                        `Found ${segments.length} segments/playlists`, 
                        'success',
                        manifestText.substring(0, 500) + '...'
                    );
                    
                    // Check for codec info
                    const codecLine = lines.find(line => line.includes('CODECS='));
                    if (codecLine) {
                        const codec = codecLine.match(/CODECS="([^"]+)"/);
                        if (codec) {
                            const isH265 = codec[1].includes('hev') || codec[1].includes('hvc');
                            addResult(
                                isH265 ? 'üé• H.265/HEVC Detected' : 'üé• H.264 Detected',
                                `Codec: ${codec[1]}`,
                                'success'
                            );
                        }
                    } else {
                        addResult('‚ö†Ô∏è No Codec Info', 'Manifest does not specify codec (might be in sub-playlist)', 'warning');
                    }
                    
                    // Test first segment
                    if (segments.length > 0) {
                        const segmentUrl = segments[0].startsWith('http') 
                            ? segments[0] 
                            : url.substring(0, url.lastIndexOf('/') + 1) + segments[0];
                        
                        addResult('üì¶ Step 3: Testing First Segment', `Fetching: ${segmentUrl}`);
                        
                        try {
                            const segResponse = await fetch(segmentUrl);
                            const segSize = segResponse.headers.get('content-length');
                            
                            if (segResponse.ok) {
                                addResult('‚úÖ Segment Accessible', 
                                    `First segment downloaded successfully (${segSize ? segSize + ' bytes' : 'size unknown'})`, 
                                    'success'
                                );
                            } else {
                                addResult('‚ùå Segment Failed', 
                                    `HTTP ${segResponse.status}: ${segResponse.statusText}`, 
                                    'error'
                                );
                            }
                        } catch (segError) {
                            addResult('‚ùå Segment Error', segError.message, 'error');
                        }
                    }
                    
                } else {
                    addResult('‚ùå Invalid Manifest', 'Response is not a valid HLS manifest', 'error', manifestText);
                }
                
            } catch (e) {
                addResult('‚ùå Manifest Fetch Failed', e.message, 'error');
            }
            
            // Test 3: Try to play
            addResult('‚ñ∂Ô∏è Step 4: Attempting Playback', 'Loading stream in video player...');
            
            video.style.display = 'block';
            video.src = url;
            
            video.addEventListener('loadedmetadata', function handler() {
                addResult('‚úÖ Metadata Loaded', 
                    `Duration: ${video.duration}s, Dimensions: ${video.videoWidth}x${video.videoHeight}`, 
                    'success'
                );
                video.removeEventListener('loadedmetadata', handler);
            });
            
            video.addEventListener('loadeddata', function handler() {
                addResult('‚úÖ Data Loaded', 'Stream data loaded successfully', 'success');
                video.removeEventListener('loadeddata', handler);
            });
            
            video.addEventListener('canplay', function handler() {
                addResult('‚úÖ Can Play', 'Stream is ready to play', 'success');
                video.removeEventListener('canplay', handler);
                video.play();
            });
            
            video.addEventListener('playing', function handler() {
                addResult('üéâ PLAYING', 'Stream is playing successfully!', 'success');
                video.removeEventListener('playing', handler);
            });
            
            video.addEventListener('error', function handler() {
                const error = video.error;
                let errorMsg = 'Unknown error';
                let detail = '';
                
                switch(error.code) {
                    case 1:
                        errorMsg = 'MEDIA_ERR_ABORTED';
                        detail = 'Loading was aborted by user or system';
                        break;
                    case 2:
                        errorMsg = 'MEDIA_ERR_NETWORK';
                        detail = 'Network error while loading stream';
                        break;
                    case 3:
                        errorMsg = 'üö® MEDIA_ERR_DECODE';
                        detail = 'DECODE ERROR - Stream has corrupted/malformed video data. This is a SERVER-SIDE issue with how the video is encoded or packaged.';
                        break;
                    case 4:
                        errorMsg = 'MEDIA_ERR_SRC_NOT_SUPPORTED';
                        detail = 'Stream format not supported';
                        break;
                }
                
                addResult('‚ùå Playback Error', `${errorMsg}: ${detail}`, 'error', `Error code: ${error.code}\nMessage: ${error.message || 'none'}`);
                video.removeEventListener('error', handler);
            });
            
            video.load();
        }
    </script>
</body>
</html>