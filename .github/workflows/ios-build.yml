name: Build iOS App for iPhone

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-for-device:
    name: Build for iPhone (Development)
    runs-on: macos-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      run: |
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
        xcodebuild -version
    
    - name: Install xcodeproj gem
      run: sudo gem install xcodeproj
    
    - name: Generate Xcode Project
      run: ruby generate_project.rb
    
    - name: Update Bundle ID for Development
      run: |
        # Use a unique bundle ID for development
        sed -i '' 's/com.iccc.alert/com.iccc.alert.dev/g' generate_project.rb
        ruby generate_project.rb
    
    - name: Build for iOS Device
      run: |
        echo "üèóÔ∏è Building for iOS device..."
        
        # Clean build directory
        rm -rf build
        mkdir -p build
        
        # Build archive
        xcodebuild \
          -project ICCCAlert.xcodeproj \
          -scheme ICCCAlert \
          -destination 'generic/platform=iOS' \
          -configuration Debug \
          -archivePath $PWD/build/ICCCAlert.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          AD_HOC_CODE_SIGNING_ALLOWED=YES
        
        echo "‚úÖ Archive created"
    
    - name: Create IPA Package
      run: |
        echo "üì¶ Creating IPA from archive..."
        
        # Set variables
        ARCHIVE_PATH="$PWD/build/ICCCAlert.xcarchive"
        APP_PATH="$ARCHIVE_PATH/Products/Applications/ICCCAlert.app"
        PAYLOAD_PATH="$PWD/build/Payload"
        IPA_PATH="$PWD/build/ICCCAlert.ipa"
        
        # Debug: Show what we have
        echo "üîç Archive contents:"
        ls -la "$ARCHIVE_PATH/Products/Applications/" || echo "‚ùå Applications directory not found!"
        
        # Verify app exists
        if [ ! -d "$APP_PATH" ]; then
          echo "‚ùå ERROR: App bundle not found at $APP_PATH"
          echo "Available files:"
          find "$ARCHIVE_PATH" -name "*.app" -type d
          exit 1
        fi
        
        echo "‚úÖ Found app at: $APP_PATH"
        
        # Create Payload directory
        mkdir -p "$PAYLOAD_PATH"
        echo "‚úÖ Created Payload directory"
        
        # Copy app to Payload
        cp -R "$APP_PATH" "$PAYLOAD_PATH/"
        echo "‚úÖ Copied app to Payload"
        
        # Verify copy
        if [ ! -d "$PAYLOAD_PATH/ICCCAlert.app" ]; then
          echo "‚ùå ERROR: Failed to copy app to Payload!"
          ls -la "$PAYLOAD_PATH/"
          exit 1
        fi
        
        echo "üìã Payload contents:"
        ls -la "$PAYLOAD_PATH/"
        
        # Create IPA (zip the Payload directory)
        cd "$PWD/build"
        zip -r -q ICCCAlert.ipa Payload
        cd ..
        
        # Verify IPA was created
        if [ ! -f "$IPA_PATH" ]; then
          echo "‚ùå ERROR: IPA file was not created!"
          echo "Current directory contents:"
          ls -la build/
          exit 1
        fi
        
        # Check IPA file
        echo "‚úÖ IPA created successfully!"
        ls -lh "$IPA_PATH"
        file "$IPA_PATH"
        
        # Verify it's a valid ZIP
        if unzip -t "$IPA_PATH" > /dev/null 2>&1; then
          echo "‚úÖ IPA is a valid ZIP archive"
        else
          echo "‚ùå WARNING: IPA may not be a valid ZIP archive"
        fi
        
        # Show IPA contents
        echo "üìã IPA contents:"
        unzip -l "$IPA_PATH" | head -20
        
        # Clean up
        rm -rf build/Payload
        rm -rf build/ICCCAlert.xcarchive
        echo "‚úÖ Cleaned up temporary files"
        
        # Final verification
        echo "üì¶ Final build directory:"
        ls -lh build/
    
    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ICCCAlert-iPhone-IPA
        path: build/ICCCAlert.ipa
        retention-days: 30
        if-no-files-found: error
    
    - name: Verify Upload
      run: |
        if [ -f "build/ICCCAlert.ipa" ]; then
          echo "‚úÖ IPA file ready for upload"
          echo "üìä File size: $(du -h build/ICCCAlert.ipa | cut -f1)"
          echo "üìä File type: $(file build/ICCCAlert.ipa)"
        else
          echo "‚ùå IPA file missing before upload!"
          exit 1
        fi
    
    - name: Installation Instructions
      run: |
        echo "‚úÖ Build complete!"
        echo ""
        echo "üì± To install on your iPhone:"
        echo ""
        echo "Method 1: Using Diawi (EASIEST)"
        echo "1. Download 'ICCCAlert-iPhone-IPA' artifact"
        echo "2. Extract the ZIP to get ICCCAlert.ipa"
        echo "3. Go to https://www.diawi.com/"
        echo "4. Upload ICCCAlert.ipa"
        echo "5. Open the Diawi link on iPhone Safari"
        echo "6. Tap Install"
        echo "7. Trust in Settings ‚Üí General ‚Üí Device Management"
        echo ""
        echo "Method 2: Manual IPA Creation (if download has no .ipa)"
        echo "1. Create a folder named 'Payload'"
        echo "2. Copy ICCCAlert.app into Payload/"
        echo "3. Zip the Payload folder"
        echo "4. Rename .zip to .ipa"
        echo "5. Upload to Diawi"

  # Keep simulator build for Appetize
  build-appetize:
    name: Build for Appetize.io
    runs-on: macos-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      run: |
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
        xcodebuild -version
    
    - name: Install xcodeproj gem
      run: sudo gem install xcodeproj
    
    - name: Generate Xcode Project
      run: ruby generate_project.rb
    
    - name: Build for iOS Simulator
      run: |
        xcodebuild \
          -project ICCCAlert.xcodeproj \
          -scheme ICCCAlert \
          -destination 'generic/platform=iOS Simulator' \
          -configuration Debug \
          -sdk iphonesimulator \
          clean build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ONLY_ACTIVE_ARCH=NO \
          ARCHS="arm64 x86_64"
        
        APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "ICCCAlert.app" -type d | head -1)
        mkdir -p ./build
        cp -R "$APP_PATH" ./build/
        cd ./build
        zip -r -y ICCCAlert-Simulator.zip ICCCAlert.app
    
    - name: Upload Appetize Build
      uses: actions/upload-artifact@v4
      with:
        name: ICCCAlert-Appetize
        path: build/ICCCAlert-Simulator.zip
        retention-days: 30