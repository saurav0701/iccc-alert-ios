name: Build iOS App for iPhone

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-for-device:
    name: Build for iPhone (Development)
    runs-on: macos-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      run: |
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
        xcodebuild -version
    
    - name: Install xcodeproj gem
      run: sudo gem install xcodeproj
    
    - name: Generate Xcode Project
      run: ruby generate_project.rb
    
    - name: Update Bundle ID for Development
      run: |
        # Use a unique bundle ID for development
        sed -i '' 's/com.iccc.alert/com.iccc.alert.dev/g' generate_project.rb
        ruby generate_project.rb
    
    - name: Build Development IPA
      run: |
        echo "üèóÔ∏è Building for iOS device..."
        
        # Clean build directory
        rm -rf build
        mkdir -p build
        
        # Build archive
        xcodebuild \
          -project ICCCAlert.xcodeproj \
          -scheme ICCCAlert \
          -destination 'generic/platform=iOS' \
          -configuration Debug \
          -archivePath $PWD/build/ICCCAlert.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          AD_HOC_CODE_SIGNING_ALLOWED=YES
        
        echo "‚úÖ Archive created"
        ls -la build/ICCCAlert.xcarchive/Products/Applications/
        
        # Create IPA manually - FIXED VERSION
        echo "üì¶ Creating IPA..."
        mkdir -p build/Payload
        
        # Copy the .app to Payload directory
        cp -R build/ICCCAlert.xcarchive/Products/Applications/ICCCAlert.app build/Payload/
        
        # Verify the app was copied
        if [ ! -d "build/Payload/ICCCAlert.app" ]; then
          echo "‚ùå ERROR: App bundle not found in Payload!"
          exit 1
        fi
        
        echo "‚úÖ App copied to Payload"
        ls -la build/Payload/
        
        # Create the IPA (just a renamed ZIP)
        cd build
        zip -r -y ICCCAlert.ipa Payload
        cd ..
        
        # Verify IPA was created
        if [ ! -f "build/ICCCAlert.ipa" ]; then
          echo "‚ùå ERROR: IPA file was not created!"
          exit 1
        fi
        
        echo "‚úÖ IPA created successfully"
        ls -lh build/ICCCAlert.ipa
        file build/ICCCAlert.ipa
        
        # Clean up Payload directory
        rm -rf build/Payload
        rm -rf build/ICCCAlert.xcarchive
        
        echo "‚úÖ Cleanup complete"
        ls -lh build/
    
    - name: Upload IPA for iPhone Installation
      uses: actions/upload-artifact@v4
      with:
        name: ICCCAlert-iPhone
        path: build/ICCCAlert.ipa
        retention-days: 30
        if-no-files-found: error
    
    - name: Installation Instructions
      run: |
        echo "‚úÖ Build complete!"
        echo ""
        echo "üì± To install on your iPhone:"
        echo ""
        echo "Method 1: Using Diawi (FREE, easiest)"
        echo "1. Download ICCCAlert.ipa from GitHub Actions artifacts"
        echo "2. Go to https://www.diawi.com/"
        echo "3. Upload the IPA file"
        echo "4. Get the link and open it on your iPhone"
        echo "5. Tap 'Install' on your iPhone"
        echo ""
        echo "Method 2: Using AltStore (FREE, requires computer)"
        echo "1. Install AltStore from https://altstore.io/"
        echo "2. Connect iPhone to computer"
        echo "3. Use AltStore to sideload the IPA"
        echo ""
        echo "Method 3: Using iOS App Signer (requires Mac)"
        echo "Visit: https://dantheman827.github.io/ios-app-signer/"

  # Keep Appetize build
  build-appetize:
    name: Build for Appetize.io
    runs-on: macos-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      run: |
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
        xcodebuild -version
    
    - name: Install xcodeproj gem
      run: sudo gem install xcodeproj
    
    - name: Generate Xcode Project
      run: ruby generate_project.rb
    
    - name: Build for iOS Simulator
      run: |
        xcodebuild \
          -project ICCCAlert.xcodeproj \
          -scheme ICCCAlert \
          -destination 'generic/platform=iOS Simulator' \
          -configuration Debug \
          -sdk iphonesimulator \
          clean build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ONLY_ACTIVE_ARCH=NO \
          ARCHS="arm64 x86_64"
        
        APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "ICCCAlert.app" -type d | head -1)
        mkdir -p ./build
        cp -R "$APP_PATH" ./build/
        cd ./build
        zip -r -y ICCCAlert-Simulator.zip ICCCAlert.app
    
    - name: Upload Appetize Build
      uses: actions/upload-artifact@v4
      with:
        name: ICCCAlert-Appetize
        path: build/ICCCAlert-Simulator.zip
        retention-days: 30