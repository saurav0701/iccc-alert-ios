name: Build iOS App for iPhone

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-for-device:
    name: Build for iPhone (Development)
    runs-on: macos-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      run: |
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
        xcodebuild -version
    
    - name: Install xcodeproj gem
      run: sudo gem install xcodeproj
    
    - name: Generate Xcode Project
      run: ruby generate_project.rb
    
    - name: Update for iOS 15.8.5 Compatibility
      run: |
        # Update deployment target to iOS 14.0 (compatible with iOS 15.8.5)
        sed -i '' "s/'14.0'/'14.0'/g" generate_project.rb
        echo "âœ… Deployment target set for iOS 14.0+ (compatible with iOS 15.8.5)"
    
    - name: Build for iOS Device
      run: |
        echo "ðŸ—ï¸ Building for iOS device (iPhone 7 - iOS 15.8.5 compatible)..."
        
        # Clean build directory
        rm -rf build
        rm -rf ~/Library/Developer/Xcode/DerivedData/ICCCAlert-*
        mkdir -p build
        
        # Build for device (ad-hoc style without signing)
        # iPhone 7 uses arm64 architecture only (armv7 is deprecated)
        xcodebuild \
          -project ICCCAlert.xcodeproj \
          -scheme ICCCAlert \
          -destination 'generic/platform=iOS' \
          -configuration Release \
          -sdk iphoneos \
          -derivedDataPath ./DerivedData \
          clean build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          PROVISIONING_PROFILE="" \
          ENABLE_BITCODE=NO \
          ONLY_ACTIVE_ARCH=NO \
          ARCHS="arm64" \
          VALID_ARCHS="arm64" \
          IPHONEOS_DEPLOYMENT_TARGET=14.0
        
        echo "âœ… Build completed"
    
    - name: Create Embedded Provisioning Profile
      run: |
        echo "ðŸ“ Creating embedded.mobileprovision for Diawi..."
        
        # Create a dummy provisioning profile (XML format)
        # This is a minimal valid provisioning profile structure
        cat > embedded.mobileprovision << 'PROFILE_EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>AppIDName</key>
    <string>ICCCAlert Development</string>
    <key>ApplicationIdentifierPrefix</key>
    <array>
        <string>*</string>
    </array>
    <key>CreationDate</key>
    <date>2025-12-12T10:00:00Z</date>
    <key>Platform</key>
    <array>
        <string>iOS</string>
    </array>
    <key>DeveloperCertificates</key>
    <array>
        <data>MIIDFzCCAgGgAwIBAgIBATANBgkqhkiG9w0BAQsFADAmMSQwIgYDVQQDDBtEZXZlbG9wZXIgQ2VydGlmaWNhdGUgRHVtbXkwHhcNMjUxMjEyMDAwMDAwWhcNMjYxMjEyMDAwMDAwWjAmMSQwIgYDVQQDDBtEZXZlbG9wZXIgQ2VydGlmaWNhdGUgRHVtbXkwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC</data>
    </array>
    <key>Entitlements</key>
    <dict>
        <key>keychain-access-groups</key>
        <array>
            <string>*</string>
        </array>
        <key>get-task-allow</key>
        <true/>
        <key>application-identifier</key>
        <string>*.com.iccc.alert</string>
        <key>com.apple.developer.team-identifier</key>
        <string>*</string>
    </dict>
    <key>ExpirationDate</key>
    <date>2026-12-12T10:00:00Z</date>
    <key>Name</key>
    <string>ICCCAlert Development Profile</string>
    <key>ProvisionedDevices</key>
    <array>
        <string>00000000-0000000000000000</string>
    </array>
    <key>TeamIdentifier</key>
    <array>
        <string>TEAMID</string>
    </array>
    <key>TeamName</key>
    <string>Development Team</string>
    <key>TimeToLive</key>
    <integer>365</integer>
    <key>UUID</key>
    <string>$(uuidgen)</string>
    <key>Version</key>
    <integer>1</integer>
</dict>
</plist>
PROFILE_EOF
        
        echo "âœ… Created embedded.mobileprovision"
    
    - name: Create Proper IPA for Diawi
      run: |
        echo "ðŸ“¦ Creating IPA package for Diawi..."
        
        # Find the built app
        APP_PATH=$(find ./DerivedData -name "ICCCAlert.app" -path "*/Build/Products/Release-iphoneos/*" -type d | head -1)
        
        if [ -z "$APP_PATH" ]; then
          echo "âŒ ERROR: Could not find ICCCAlert.app"
          echo "Searching in DerivedData:"
          find ./DerivedData -name "*.app" -type d
          exit 1
        fi
        
        echo "âœ… Found app at: $APP_PATH"
        
        # Verify app bundle structure
        echo "ðŸ“‹ App bundle contents:"
        ls -la "$APP_PATH"
        
        # Check for executable
        if [ -f "$APP_PATH/ICCCAlert" ]; then
          echo "âœ… Executable found"
          file "$APP_PATH/ICCCAlert"
          lipo -info "$APP_PATH/ICCCAlert" || echo "âš ï¸ Could not read architectures"
        else
          echo "âŒ ERROR: Executable not found in app bundle"
          exit 1
        fi
        
        # Add embedded provisioning profile to app bundle
        echo "ðŸ“ Adding embedded.mobileprovision to app..."
        cp embedded.mobileprovision "$APP_PATH/embedded.mobileprovision"
        
        if [ -f "$APP_PATH/embedded.mobileprovision" ]; then
          echo "âœ… Provisioning profile added to app bundle"
          ls -lh "$APP_PATH/embedded.mobileprovision"
        else
          echo "âŒ ERROR: Failed to add provisioning profile"
          exit 1
        fi
        
        # Create Payload directory structure
        PAYLOAD_DIR="./build/Payload"
        mkdir -p "$PAYLOAD_DIR"
        
        # Copy app bundle to Payload
        echo "ðŸ“¦ Copying app to Payload directory..."
        cp -R "$APP_PATH" "$PAYLOAD_DIR/"
        
        # Verify copy
        if [ ! -d "$PAYLOAD_DIR/ICCCAlert.app" ]; then
          echo "âŒ ERROR: Failed to copy app to Payload"
          exit 1
        fi
        
        # Verify provisioning profile is in the copied app
        if [ ! -f "$PAYLOAD_DIR/ICCCAlert.app/embedded.mobileprovision" ]; then
          echo "âš ï¸ Provisioning profile missing in Payload, copying again..."
          cp embedded.mobileprovision "$PAYLOAD_DIR/ICCCAlert.app/embedded.mobileprovision"
        fi
        
        echo "âœ… App copied to Payload with provisioning profile"
        echo "ðŸ“‹ Payload structure:"
        ls -la "$PAYLOAD_DIR"
        ls -la "$PAYLOAD_DIR/ICCCAlert.app" | head -15
        
        # Create IPA (zip file with .ipa extension)
        echo "ðŸ—œï¸ Creating IPA archive..."
        cd ./build
        
        # Remove any existing IPA
        rm -f ICCCAlert.ipa
        
        # Create zip without compression for better compatibility
        zip -r -0 ICCCAlert.ipa Payload
        
        cd ..
        
        # Verify IPA was created
        if [ ! -f "./build/ICCCAlert.ipa" ]; then
          echo "âŒ ERROR: IPA was not created"
          exit 1
        fi
        
        # Get IPA info
        IPA_SIZE=$(du -h ./build/ICCCAlert.ipa | cut -f1)
        echo "âœ… IPA created successfully!"
        echo "ðŸ“Š IPA size: $IPA_SIZE"
        
        # Verify IPA structure including provisioning profile
        echo "ðŸ“‹ Verifying IPA structure..."
        unzip -l ./build/ICCCAlert.ipa | grep -E "(Payload|ICCCAlert.app|Info.plist|ICCCAlert$|embedded.mobileprovision)" | head -25
        
        # Specifically check for provisioning profile in IPA
        if unzip -l ./build/ICCCAlert.ipa | grep -q "embedded.mobileprovision"; then
          echo "âœ… Provisioning profile is embedded in IPA"
        else
          echo "âŒ ERROR: Provisioning profile NOT found in IPA"
          exit 1
        fi
        
        # Test IPA integrity
        if unzip -t ./build/ICCCAlert.ipa > /dev/null 2>&1; then
          echo "âœ… IPA is a valid ZIP archive"
        else
          echo "âŒ ERROR: IPA is not a valid ZIP archive"
          exit 1
        fi
        
        # Check file type
        file ./build/ICCCAlert.ipa
        
        echo "âœ… IPA is ready for Diawi upload!"
    
    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ICCCAlert-iPhone-IPA
        path: build/ICCCAlert.ipa
        retention-days: 30
        if-no-files-found: error
    
    - name: Create Installation Guide
      run: |
        cat > ./build/INSTALLATION_GUIDE.txt << 'EOF'
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  ICCCAlert - iPhone 7 (iOS 15.8.5) Installation Guide       â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        ðŸ“± DEVICE COMPATIBILITY:
        âœ… iPhone 7 running iOS 15.8.5 - FULLY COMPATIBLE
        âœ… This build supports arm64 architecture (A10 Fusion chip)
        âœ… Minimum iOS version: 14.0

        ðŸš€ INSTALLATION STEPS (Using Diawi):

        1ï¸âƒ£ DOWNLOAD THE IPA:
           - Download the "ICCCAlert-iPhone-IPA" artifact from GitHub Actions
           - Extract the ZIP file to get ICCCAlert.ipa
           - Verify file size is reasonable (should be several MB)

        2ï¸âƒ£ UPLOAD TO DIAWI:
           - Go to https://www.diawi.com/
           - Click "Send your app"
           - Upload ICCCAlert.ipa file
           - Wait for upload to complete
           - You'll get a short link (e.g., https://i.diawi.com/xxxxxx)

        3ï¸âƒ£ INSTALL ON IPHONE:
           - Open Safari on your iPhone 7
           - Type or scan the Diawi link
           - Tap the "Install" button on the Diawi page
           - Confirm installation when prompted

        4ï¸âƒ£ TRUST THE DEVELOPER:
           - Go to: Settings â†’ General â†’ VPN & Device Management
           - Find "Enterprise App" or unsigned app profile
           - Tap on it and select "Trust"
           - The app icon should now appear on your home screen

        5ï¸âƒ£ LAUNCH THE APP:
           - Tap the ICCCAlert icon
           - The app should launch successfully!

        âš ï¸ TROUBLESHOOTING:

        If Diawi shows "Unsupported File":
        - Make sure you uploaded the .ipa file, not the .zip
        - Check that the file is not corrupted
        - Try re-downloading from GitHub Actions

        If "Unable to Install":
        - Check your iPhone storage (need at least 100MB free)
        - Restart your iPhone and try again
        - Make sure you're using Safari (not Chrome)

        If "Untrusted Developer" appears:
        - This is NORMAL for unsigned apps
        - Follow step 4ï¸âƒ£ to trust the app

        If app crashes on launch:
        - This might indicate architecture mismatch
        - Report the issue with crash logs

        ðŸ“ ALTERNATIVE METHOD (iTunes/Finder):
        If Diawi doesn't work, you can install via computer:
        1. Connect iPhone to Mac/PC
        2. Open Finder (Mac) or iTunes (Windows)
        3. Drag ICCCAlert.ipa to your iPhone
        4. Follow trust steps above

        ðŸ”„ FOR DEVELOPERS:
        This is an unsigned build. For proper App Store distribution:
        - You'll need an Apple Developer Account ($99/year)
        - Configure code signing with valid certificate
        - Create a provisioning profile
        - Use TestFlight for beta testing

        ðŸ“± CURRENT BUILD INFO:
        - Target: iPhone (arm64 only)
        - Min iOS: 14.0
        - Tested on: iOS 15.8.5
        - iPhone 7: A10 Fusion chip (64-bit)
        - Build Type: Release (unsigned)
        - Created: $(date)

        âœ… Good luck with testing! Report any issues on GitHub.
        EOF
        
        cat ./build/INSTALLATION_GUIDE.txt
    
    - name: Upload Installation Guide
      uses: actions/upload-artifact@v4
      with:
        name: Installation-Guide
        path: build/INSTALLATION_GUIDE.txt
        retention-days: 30
    
    - name: Final Summary
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘         âœ… BUILD COMPLETED SUCCESSFULLY!              â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ðŸ“¦ Artifacts created:"
        ls -lh ./build/
        echo ""
        echo "ðŸŽ¯ Next Steps:"
        echo "1. Download 'ICCCAlert-iPhone-IPA' artifact"
        echo "2. Extract to get ICCCAlert.ipa"
        echo "3. Upload to https://www.diawi.com/"
        echo "4. Install on iPhone 7 via Safari"
        echo "5. Trust in Settings â†’ General â†’ Device Management"
        echo ""
        echo "ðŸ“± iPhone 7 (iOS 15.8.5) - READY TO TEST!"
        echo "ðŸ“‹ See Installation-Guide.txt for detailed instructions"
        echo ""

  # Keep simulator build for future use (Appetize.io)
  build-simulator:
    name: Build for Simulator (Optional)
    runs-on: macos-latest
    if: false  # Disabled by default, enable if needed
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      run: |
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
        xcodebuild -version
    
    - name: Install xcodeproj gem
      run: sudo gem install xcodeproj
    
    - name: Generate Xcode Project
      run: ruby generate_project.rb
    
    - name: Build for iOS Simulator
      run: |
        xcodebuild \
          -project ICCCAlert.xcodeproj \
          -scheme ICCCAlert \
          -destination 'generic/platform=iOS Simulator' \
          -configuration Debug \
          -sdk iphonesimulator \
          -derivedDataPath ./DerivedData \
          clean build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          ONLY_ACTIVE_ARCH=NO \
          ARCHS="arm64 x86_64"
        
        APP_PATH=$(find ./DerivedData -name "ICCCAlert.app" -type d | head -1)
        mkdir -p ./build
        cp -R "$APP_PATH" ./build/
        cd ./build
        zip -r -y ICCCAlert-Simulator.zip ICCCAlert.app
    
    - name: Upload Simulator Build
      uses: actions/upload-artifact@v4
      with:
        name: ICCCAlert-Simulator
        path: build/ICCCAlert-Simulator.zip
        retention-days: 30