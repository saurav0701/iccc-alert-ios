name: Build iOS App - Simple Version

on:
  workflow_dispatch:
    inputs:
      team_id:
        description: 'Your Team ID (get from developer.apple.com/account)'
        required: true
        type: string

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      run: |
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
        xcodebuild -version
    
    - name: Install Tools
      run: |
        sudo gem install xcodeproj
        sudo gem install fastlane -NV
    
    - name: Generate Project
      run: ruby generate_project.rb
    
    - name: Configure
      env:
        TEAM_ID: ${{ github.event.inputs.team_id }}
      run: |
        BUNDLE_ID="com.iccc.alert.$(date +%Y%m%d)"
        echo "BUNDLE_ID=$BUNDLE_ID" >> $GITHUB_ENV
        echo "TEAM_ID=$TEAM_ID" >> $GITHUB_ENV
        /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier $BUNDLE_ID" ICCCAlert/Info.plist || true
    
    - name: Setup Credentials
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APP_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
      run: |
        echo "APPLE_ID=$APPLE_ID" >> $GITHUB_ENV
        echo "FASTLANE_USER=$APPLE_ID" >> $GITHUB_ENV
        echo "FASTLANE_PASSWORD=$APP_SPECIFIC_PASSWORD" >> $GITHUB_ENV
        echo "FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD=$APP_SPECIFIC_PASSWORD" >> $GITHUB_ENV
        echo "FASTLANE_DONT_STORE_PASSWORD=1" >> $GITHUB_ENV
    
    - name: Create Keychain
      run: |
        security create-keychain -p temp temp.keychain
        security default-keychain -s temp.keychain
        security unlock-keychain -p temp temp.keychain
        security set-keychain-settings -t 3600 temp.keychain
    
    - name: Setup Fastlane
      run: |
        mkdir -p fastlane
        
        cat > fastlane/Appfile << EOF
        apple_id ENV["APPLE_ID"]
        team_id ENV["TEAM_ID"]
        
        for_platform :ios do
          app_identifier ENV["BUNDLE_ID"]
        end
        EOF
        
        cat > fastlane/Fastfile << 'EOF'
        default_platform(:ios)
        
        platform :ios do
          lane :build do
            cert(
              username: ENV["APPLE_ID"],
              team_id: ENV["TEAM_ID"],
              development: true
            )
            
            sigh(
              username: ENV["APPLE_ID"],
              app_identifier: ENV["BUNDLE_ID"],
              team_id: ENV["TEAM_ID"],
              development: true,
              force: true
            )
            
            gym(
              project: "ICCCAlert.xcodeproj",
              scheme: "ICCCAlert",
              export_method: "development",
              configuration: "Release",
              output_directory: "./build",
              output_name: "ICCCAlert-Signed.ipa",
              export_options: {
                method: "development",
                teamID: ENV["TEAM_ID"]
              }
            )
          end
        end
        EOF
    
    - name: Build
      run: |
        cd fastlane
        fastlane build
    
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: ICCCAlert-Signed-IPA
        path: build/ICCCAlert-Signed.ipa
    
    - name: Success
      run: |
        echo "âœ… Build complete!"
        echo "ðŸ“¦ Download the IPA artifact"
        echo "ðŸ“² Upload to https://www.diawi.com/"
        echo "ðŸ“± Install on iPhone 7"