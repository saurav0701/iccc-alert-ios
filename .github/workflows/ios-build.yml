name: Extract Team ID (Free Apple Account)

on:
  workflow_dispatch:

jobs:
  get-team-id:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      run: |
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
        xcodebuild -version
    
    - name: Install Tools
      run: |
        sudo gem install xcodeproj
        sudo gem install fastlane -NV
    
    - name: Generate Project
      run: ruby generate_project.rb
    
    - name: Extract Team ID
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APP_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ” Extracting your Team ID..."
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        export FASTLANE_PASSWORD="$APP_SPECIFIC_PASSWORD"
        export FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD="$APP_SPECIFIC_PASSWORD"
        export FASTLANE_DONT_STORE_PASSWORD=1
        
        # Create Ruby script
        cat > list_teams.rb << 'EOF'
        require 'spaceship'
        
        begin
          puts "Authenticating with Apple..."
          
          Spaceship::Portal.login(ENV['APPLE_ID'], ENV['FASTLANE_PASSWORD'])
          
          teams = Spaceship::Portal.client.teams
          
          if teams && teams.count > 0
            puts ""
            puts "="*60
            puts "SUCCESS! FOUND YOUR TEAM(S):"
            puts "="*60
            
            teams.each do |team|
              puts ""
              puts "Team Name: #{team['name']}"
              puts "Team ID:   #{team['teamId']}"
              puts "Type:      #{team['type']}"
              puts "-"*60
              
              File.write('TEAM_ID.txt', team['teamId'])
            end
            
            puts ""
            puts "Team ID saved!"
          else
            puts "No teams found"
          end
          
        rescue => e
          puts ""
          puts "Error: #{e.message}"
          
          if e.message =~ /([A-Z0-9]{10})/
            puts "Found Team ID: #{$1}"
            File.write('TEAM_ID.txt', $1)
          end
        end
        EOF
        
        ruby list_teams.rb || true
    
    - name: Display Result
      if: always()
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        if [ -f "TEAM_ID.txt" ]; then
          TEAM_ID=$(cat TEAM_ID.txt)
          echo "YOUR TEAM ID: $TEAM_ID"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ADD THIS TO GITHUB:"
          echo "Settings â†’ Secrets â†’ Actions â†’ New secret"
          echo "Name: TEAM_ID"
          echo "Value: $TEAM_ID"
        else
          echo "Could not extract Team ID automatically"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Check the output above for Team ID"
          echo "Look for 10-character codes like: ABC1234XYZ"
        fi
    
    - name: Upload-
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Team-ID-Info
        path: TEAM_ID.txt
        if-no-files-found: ignore
        retention-days: 7