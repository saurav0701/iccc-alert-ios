name: iOS Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build iOS App
    runs-on: macos-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      run: |
        sudo xcode-select -switch /Applications/Xcode_15.1.app
        xcodebuild -version
    
    - name: Install xcodeproj gem
      run: |
        sudo gem install xcodeproj
    
    - name: Generate Xcode Project
      run: |
        cat > generate_project.rb << 'RUBY'
        require 'xcodeproj'
        
        project_name = 'ICCCAlert'
        project_path = "#{project_name}.xcodeproj"
        
        # Create project
        project = Xcodeproj::Project.new(project_path)
        
        # Create target
        target = project.new_target(:application, project_name, :ios, '14.0')
        
        # Create groups
        main_group = project.main_group.new_group(project_name)
        
        # Find and add all Swift files recursively
        swift_files = Dir.glob("#{project_name}/**/*.swift")
        
        puts "ðŸ“ Found #{swift_files.count} Swift files:"
        swift_files.each { |f| puts "  - #{f}" }
        
        swift_files.each do |file|
          file_ref = main_group.new_reference(file)
          target.add_file_references([file_ref])
        end
        
        # Configure build settings
        target.build_configurations.each do |config|
          config.build_settings['PRODUCT_NAME'] = project_name
          config.build_settings['PRODUCT_BUNDLE_IDENTIFIER'] = 'com.example.iccc-alert'
          config.build_settings['SWIFT_VERSION'] = '5.9'
          config.build_settings['TARGETED_DEVICE_FAMILY'] = '1,2'
          config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '14.0'
          config.build_settings['CODE_SIGN_IDENTITY'] = ''
          config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
          config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
          config.build_settings['ENABLE_BITCODE'] = 'NO'
        end
        
        # Save
        project.save
        puts "âœ… Project created: #{project_path}"
        RUBY
        
        ruby generate_project.rb
    
    - name: List Project Contents
      run: |
        echo "ðŸ“¦ Xcode project created:"
        ls -la *.xcodeproj
        echo ""
        echo "ðŸ“ Project structure:"
        find ICCCAlert -name "*.swift"
    
    - name: Build for Simulator
      run: |
        xcodebuild \
          -project ICCCAlert.xcodeproj \
          -scheme ICCCAlert \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
          -configuration Debug \
          clean build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
    
    - name: Build Success
      if: success()
      run: |
        echo "âœ… iOS app built successfully!"
        echo "ðŸ“± Ready for simulator testing"
    
    - name: Upload Build Log
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ~/Library/Logs/
          *.log

# âœ… THIS WORKFLOW:
# 1. Installs xcodeproj gem (Ruby library)
# 2. Generates complete Xcode project from your Swift files
# 3. Builds for iOS Simulator
# 4. No code signing needed for simulator builds