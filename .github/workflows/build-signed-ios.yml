name: Build iOS App with FREE Code Signing (No $99!)

on:
  workflow_dispatch:
  push:
    branches: [ main, develop ]

jobs:
  build-signed-ipa:
    name: Build Signed IPA (7-Day Certificate)
    runs-on: macos-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Display Info
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Building iOS App with FREE Apple ID Code Signing"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ðŸ“± Target Device: iPhone 7 (iOS 15.8.5)"
        echo "â° Certificate Validity: 7 days"
        echo "ðŸ’° Cost: FREE (No Apple Developer Account needed!)"
        echo "ðŸ”„ After 7 days: Just rebuild and reinstall"
        echo ""
    
    - name: Setup Xcode
      run: |
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
        xcodebuild -version
    
    - name: Install Dependencies
      run: |
        sudo gem install xcodeproj
        brew install ruby
    
    - name: Generate Xcode Project
      run: ruby generate_project.rb
    
    - name: Configure Bundle Identifier
      run: |
        # Use a unique bundle ID with your domain or a generic one
        BUNDLE_ID="com.iccc.alert.$(date +%Y%m%d)"
        echo "Using Bundle ID: $BUNDLE_ID"
        echo "BUNDLE_ID=$BUNDLE_ID" >> $GITHUB_ENV
        
        # Update Info.plist with bundle ID
        /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier $BUNDLE_ID" ICCCAlert/Info.plist || true
    
    - name: Setup Fastlane
      run: |
        sudo gem install fastlane -NV
        
        # Create Fastlane directory
        mkdir -p fastlane
        
        # Create Appfile
        cat > fastlane/Appfile << EOF
        apple_id ENV["APPLE_ID"]
        team_id ENV["TEAM_ID"]
        
        for_platform :ios do
          app_identifier ENV["BUNDLE_ID"]
        end
        EOF
        
        # Create Fastfile - SIMPLIFIED VERSION
        cat > fastlane/Fastfile << 'EOF'
        default_platform(:ios)

        platform :ios do
          desc "Build and sign the app with free provisioning"
          lane :build_free do
            
            # Skip device registration if TEAM_ID is not set
            # We'll register it manually via Xcode on Mac instead
            
            # Get certificates (creates if needed)
            cert(
              username: ENV["APPLE_ID"],
              team_id: ENV["TEAM_ID"],
              development: true
            )

            # Get provisioning profile (creates if needed)
            sigh(
              username: ENV["APPLE_ID"],
              app_identifier: ENV["BUNDLE_ID"],
              team_id: ENV["TEAM_ID"],
              development: true,
              force: true,
              skip_certificate_verification: false
            )

            # Build the app
            gym(
              project: "ICCCAlert.xcodeproj",
              scheme: "ICCCAlert",
              export_method: "development",
              configuration: "Release",
              output_directory: "./build",
              output_name: "ICCCAlert-Signed.ipa",
              export_options: {
                method: "development",
                signingStyle: "automatic",
                teamID: ENV["TEAM_ID"],
                iCloudContainerEnvironment: "Development"
              }
            )
          end
          
          desc "Just get your Team ID"
          lane :get_team_id do
            puts "ðŸ” Fetching your Team ID..."
            
            # This will list all teams associated with your Apple ID
            # and help you find your personal Team ID
            teams = CredentialsManager::AccountManager.new(
              user: ENV["APPLE_ID"]
            ).teams
            
            puts "\nâœ… Found these teams for #{ENV['APPLE_ID']}:"
            teams.each do |team|
              puts "   Team Name: #{team['name']}"
              puts "   Team ID: #{team['teamId']}"
              puts "   Type: #{team['type']}"
              puts ""
            end
            
            puts "Add your Team ID as a GitHub Secret: TEAM_ID"
          end
        end
        EOF
        
        echo "âœ… Fastlane configured"
    
    - name: Setup Credentials
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APP_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
        IPHONE_UDID: ${{ secrets.IPHONE_UDID }}
        TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        if [ -z "$APPLE_ID" ]; then
          echo "âŒ ERROR: APPLE_ID secret not set!"
          echo "Please add your Apple ID email in GitHub Secrets"
          exit 1
        fi
        
        if [ -z "$APP_SPECIFIC_PASSWORD" ]; then
          echo "âŒ ERROR: APP_SPECIFIC_PASSWORD secret not set!"
          echo ""
          echo "ðŸ“ How to create App-Specific Password:"
          echo "1. Go to https://appleid.apple.com/"
          echo "2. Sign in"
          echo "3. Security section â†’ App-Specific Passwords"
          echo "4. Click '+' or 'Generate Password'"
          echo "5. Name it 'GitHub Fastlane'"
          echo "6. Copy the password (format: xxxx-xxxx-xxxx-xxxx)"
          echo "7. Add it as APP_SPECIFIC_PASSWORD in GitHub Secrets"
          exit 1
        fi
        
        if [ -z "$IPHONE_UDID" ]; then
          echo "âš ï¸ WARNING: IPHONE_UDID secret not set!"
          echo "We'll continue but device won't be auto-registered"
          echo ""
          echo "ðŸ“ How to get iPhone UDID:"
          echo "Mac: Connect iPhone â†’ Open Finder â†’ Click iPhone â†’ Click serial number to show UDID"
          echo "Copy UDID and add as IPHONE_UDID in GitHub Secrets"
        fi
        
        if [ -z "$TEAM_ID" ]; then
          echo "âš ï¸ WARNING: TEAM_ID secret not set!"
          echo "This is REQUIRED for signing. We'll try to fetch it..."
        fi
        
        echo "âœ… Credentials validated"
        echo "Apple ID: $APPLE_ID"
        if [ -n "$IPHONE_UDID" ]; then
          echo "UDID: ${IPHONE_UDID:0:10}..."
        fi
        
        # Setup environment
        echo "APPLE_ID=$APPLE_ID" >> $GITHUB_ENV
        echo "FASTLANE_PASSWORD=$APP_SPECIFIC_PASSWORD" >> $GITHUB_ENV
        echo "FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD=$APP_SPECIFIC_PASSWORD" >> $GITHUB_ENV
        echo "FASTLANE_DONT_STORE_PASSWORD=1" >> $GITHUB_ENV
        echo "FASTLANE_SESSION=" >> $GITHUB_ENV
        
        if [ -n "$IPHONE_UDID" ]; then
          echo "IPHONE_UDID=$IPHONE_UDID" >> $GITHUB_ENV
          echo "IPHONE_NAME=iPhone7-Test" >> $GITHUB_ENV
        fi
        
        if [ -n "$TEAM_ID" ]; then
          echo "TEAM_ID=$TEAM_ID" >> $GITHUB_ENV
        fi
    
    - name: Create Keychain
      run: |
        # Create temporary keychain for GitHub Actions
        security create-keychain -p temp_password temp.keychain
        security default-keychain -s temp.keychain
        security unlock-keychain -p temp_password temp.keychain
        security set-keychain-settings -t 3600 -l ~/Library/Keychains/temp.keychain
        
        echo "âœ… Keychain created and unlocked"
    
    - name: Get Team ID (if not set)
      if: ${{ !secrets.TEAM_ID }}
      continue-on-error: true
      run: |
        echo "ðŸ” Attempting to get your Team ID..."
        cd fastlane
        fastlane get_team_id || {
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš ï¸ Could not fetch Team ID automatically"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“ Manual Method to Get Team ID:"
          echo ""
          echo "On your Mac:"
          echo "1. Open Xcode"
          echo "2. Open your ICCCAlert project"
          echo "3. Select the project in left sidebar"
          echo "4. Go to 'Signing & Capabilities' tab"
          echo "5. Check 'Automatically manage signing'"
          echo "6. Select 'Personal Team' in Team dropdown"
          echo "7. Your Team ID will appear next to team name"
          echo "   (Format: ABC1234XYZ or similar)"
          echo ""
          echo "8. Add this as GitHub Secret: TEAM_ID = YOUR_TEAM_ID"
          echo ""
          exit 1
        }
    
    - name: Build with Fastlane
      if: ${{ secrets.TEAM_ID }}
      run: |
        echo "ðŸ—ï¸ Starting build with FREE code signing..."
        cd fastlane
        fastlane build_free || {
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš ï¸ BUILD FAILED - Common Issues:"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "1. âŒ Wrong App-Specific Password"
          echo "   â†’ Generate NEW password at appleid.apple.com"
          echo "   â†’ Update APP_SPECIFIC_PASSWORD secret"
          echo ""
          echo "2. âŒ 2FA not enabled on Apple ID"
          echo "   â†’ Go to appleid.apple.com â†’ Security"
          echo "   â†’ Enable Two-Factor Authentication"
          echo ""
          echo "3. âŒ Wrong Apple ID"
          echo "   â†’ Check APPLE_ID secret is your actual Apple ID email"
          echo ""
          echo "4. âŒ Wrong TEAM_ID"
          echo "   â†’ Check TEAM_ID in GitHub Secrets"
          echo "   â†’ Get it from Xcode (see instructions above)"
          echo ""
          exit 1
        }
    
    - name: Verify IPA
      if: ${{ secrets.TEAM_ID }}
      run: |
        if [ -f "./build/ICCCAlert-Signed.ipa" ]; then
          echo "âœ… Signed IPA created successfully!"
          ls -lh ./build/ICCCAlert-Signed.ipa
          
          # Show IPA contents
          echo ""
          echo "ðŸ“‹ IPA Contents:"
          unzip -l ./build/ICCCAlert-Signed.ipa | grep -E "(Payload|embedded.mobileprovision|ICCCAlert)" | head -20
          
          # Check for provisioning profile
          if unzip -l ./build/ICCCAlert-Signed.ipa | grep -q "embedded.mobileprovision"; then
            echo "âœ… Provisioning profile is embedded"
          else
            echo "âš ï¸ Warning: No provisioning profile found"
          fi
        else
          echo "âŒ ERROR: IPA was not created"
          echo "Checking build directory:"
          ls -la ./build/ || echo "Build directory doesn't exist"
          exit 1
        fi
    
    - name: Upload Signed IPA
      if: ${{ secrets.TEAM_ID }}
      uses: actions/upload-artifact@v4
      with:
        name: ICCCAlert-Signed-IPA
        path: build/ICCCAlert-Signed.ipa
        retention-days: 30
    
    - name: Create Installation Guide
      if: ${{ secrets.TEAM_ID }}
      run: |
        cat > ./build/INSTALLATION_INSTRUCTIONS.txt << 'EOF'
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  ICCCAlert - FREE Signed IPA Installation Guide              â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        ðŸŽ‰ CONGRATULATIONS! Your app is properly signed!

        This IPA is signed with your FREE Apple ID and will work for 7 DAYS.

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        ðŸ“± INSTALLATION METHOD 1: Using Mac Finder (EASIEST!)

        1. Download the "ICCCAlert-Signed-IPA" artifact from GitHub Actions
        2. Extract to get: ICCCAlert-Signed.ipa
        3. Connect your iPhone 7 to your Mac via USB
        4. Open Finder
        5. Click on your iPhone in the sidebar (under "Locations")
        6. Drag ICCCAlert-Signed.ipa onto the iPhone window
        7. Wait for installation to complete
        8. Done! âœ…

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        ðŸ“± INSTALLATION METHOD 2: Using Xcode

        1. Open Xcode on your Mac
        2. Go to Window â†’ Devices and Simulators
        3. Select your iPhone 7 from the list
        4. Click the "+" button under "Installed Apps"
        5. Select ICCCAlert-Signed.ipa
        6. Wait for installation
        7. Done! âœ…

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        ðŸ”“ TRUST THE CERTIFICATE (REQUIRED!)

        After installation, you MUST trust the developer certificate:

        1. On your iPhone 7, open Settings
        2. Go to: General â†’ VPN & Device Management
        3. Under "Developer App", find your Apple ID
        4. Tap on it
        5. Tap "Trust [Your Apple ID]"
        6. Confirm by tapping "Trust" again
        7. Done! Now launch the app from home screen

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        âœ… YOUR APP IS NOW WORKING!

        You can now test:
        âœ… WebSocket connections
        âœ… All app features  
        âœ… Real device performance
        âœ… iOS 15.8.5 compatibility

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        â° AFTER 7 DAYS:

        Your certificate will expire after 7 days. This is normal for free signing!

        To renew:
        1. Go to GitHub Actions
        2. Click "Actions" tab
        3. Select "Build iOS App with FREE Code Signing"
        4. Click "Run workflow" â†’ "Run workflow"
        5. Wait for build to complete
        6. Download new IPA
        7. Reinstall on iPhone (takes 2 minutes!)

        ðŸ’¡ TIP: Set a calendar reminder for 6 days from now

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        âš ï¸ TROUBLESHOOTING:

        "Unable to verify app":
        â†’ Go to Settings â†’ General â†’ Device Management
        â†’ Trust your Apple ID (see steps above)
        â†’ If still failing, delete app and reinstall

        "This app cannot be installed":
        â†’ Make sure you're using the SIGNED IPA from GitHub Actions
        â†’ Try restarting your iPhone
        â†’ Check that bundle ID matches in Xcode

        App crashes on launch:
        â†’ Connect iPhone to Mac
        â†’ Open Xcode â†’ Window â†’ Devices
        â†’ View crash logs under "View Device Logs"
        â†’ Share logs with developer

        "Untrusted Developer":
        â†’ You MUST trust the certificate (see steps above)
        â†’ This is required for all free Apple ID signed apps

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        ðŸ’° COST BREAKDOWN:

        Current Setup (FREE):
        - Apple ID: $0
        - Code Signing: $0 (7-day certificates)
        - GitHub Actions: $0 (free tier)
        - Installation: $0 (direct via Mac)

        Total: $0 per year! ðŸŽ‰

        Paid Option (if you need it):
        - Apple Developer Program: $99/year
        - Benefits: 1-year certificates, TestFlight, App Store publishing

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        ðŸŽ‰ ENJOY YOUR APP!

        Your app is now running on your iPhone 7!
        Questions? Check the GitHub Actions logs for details.
        EOF
        
        cat ./build/INSTALLATION_INSTRUCTIONS.txt
    
    - name: Upload Installation Guide
      if: ${{ secrets.TEAM_ID }}
      uses: actions/upload-artifact@v4
      with:
        name: Installation-Instructions
        path: build/INSTALLATION_INSTRUCTIONS.txt
        retention-days: 30
    
    - name: Success Summary
      if: ${{ secrets.TEAM_ID }}
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘     ðŸŽ‰ SUCCESS! YOUR APP IS SIGNED AND READY! ðŸŽ‰      â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ðŸ“¦ Download these artifacts:"
        echo "   1. ICCCAlert-Signed-IPA (the signed app)"
        echo "   2. Installation-Instructions (installation guide)"
        echo ""
        echo "â° Valid for: 7 days"
        echo "ðŸ’° Cost: FREE!"
        echo "ðŸ“± Ready to install on your iPhone 7 via Mac!"
        echo ""
        echo "ðŸš€ Next steps on your Mac:"
        echo "   1. Download the IPA artifact"
        echo "   2. Connect iPhone 7 via USB"
        echo "   3. Open Finder"
        echo "   4. Drag IPA onto iPhone"
        echo "   5. Trust certificate in iPhone Settings"
        echo "   6. Launch and test!"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"